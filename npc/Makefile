DIR = ./obj_dir
EXE = $(BUILD_DIR)/$(TOPNAME)
WAVE = waveform.vcd

# SO = -so
# NAME = riscv32-npc

all:$(BIN)

# Extract variabls from menuconfig
GUEST_ISA ?= $(call remove_quote,$(CONFIG_ISA))
ENGINE ?= $(call remove_quote,$(CONFIG_ENGINE))
NAME    = $(GUEST_ISA)-npc-$(ENGINE)
TOPNAME = ysyxSoCFull
YSYXSOC_HOME = $(NPC_HOME)/../ysyxSoC

# Include variables and rules generated by menuconfig
-include $(NPC_HOME)/include/config/auto.conf
-include $(NPC_HOME)/include/config/auto.conf.cmd

remove_quote = $(patsubst "%",%,$(1))

# Include all filelist.mk to merge file lists
FILELIST_MK = $(shell find -L ./csrc -name "filelist.mk")
include $(FILELIST_MK)

# Filter out directories and files in blacklist to obtain the final set of source files
DIRS-BLACKLIST-y += $(DIRS-BLACKLIST)
CSRCS-BLACKLIST-y += $(CSRCS-BLACKLIST) $(shell find -L $(DIRS-BLACKLIST-y) -name "*.c")
CSRCS-y += $(shell find -L $(DIRS-y) -name "*.c")
CSRCS = $(filter-out $(CSRCS-BLACKLIST-y),$(CSRCS-y))

# Include rules for menuconfig
include $(NPC_HOME)/scripts/config.mk
include $(NPC_HOME)/scripts/difftest.mk

# project source
VSRCS = $(shell find $(abspath ./vsrc) -name "*.v") $(shell find -L $(YSYXSOC_HOME)/perip -name "*.v") $(YSYXSOC_HOME)/build/ysyxSoCFull.v
# CSRCS = $(shell find $(abspath ./csrc) -name "*.c" -or -name "*.cpp" -or -name "*.cc")
# CSRCS += $(shell find $(abspath ./csrc/device) -name "*.c" -or -name "*.cpp" -or -name "*.cc")
SRCS = $(CXXSRC) $(CSRCS)


NXDC_FILES = constr/ysyx_22041211_top.nxdc
INC_PATH += $(NPC_HOME)/include 

VERILATOR_INC_PATH = $(NPC_HOME)/vsrc/  $(YSYXSOC_HOME)/perip/uart16550/rtl $(YSYXSOC_HOME)/perip/spi/rtl
VERILATOR_INCLUDE = $(addprefix -I, $(VERILATOR_INC_PATH))

VERILATOR = verilator
VERILATOR_CFLAGS += -MMD --cc   --build -j 0  \
				-O3 --x-assign fast --x-initial fast --assert --public $(VERILATOR_INCLUDE)  \
				--timescale "1ns/1ns" --no-timing  --trace --autoflush #-Wall

#-ggdb -LDFLAGS -ggdb -CFLAGS -DVL_DEBUG=1 
# -CFLAGS -D_GLIBCXX_DEBUG

WORK_DIR  = $(shell pwd)
override BUILD_DIR ?= $(WORK_DIR)/build
OBJ_DIR = $(BUILD_DIR)/obj_dir
BIN = $(BUILD_DIR)/$(TOPNAME)

CXXSRC = $(NPC_HOME)/csrc/utils/disasm.cc
# --cxxflags 选项表示获取与 C++ 相关的编译器选项，输出使用LLVM头文件所需要的C++编译选项
# llvm-config 让使用LLVM构建的应用程序变得很容易，他可以打印链接LLVM所需的编译器标志，编译器标志和对象库
CXXFLAGS += $(shell llvm-config --cxxflags) -fPIE 

# --libs 打印链接指定LLVM 组件所需的所有库 ，包括任何依赖项。

LIBS += $(shell llvm-config --libs)

all: default

default: $(BIN)


$(shell mkdir -p $(BUILD_DIR))

# constraint file
SRC_AUTO_BIND = $(abspath $(BUILD_DIR)/auto_bind.cpp)
$(SRC_AUTO_BIND): $(NXDC_FILES)
	python3 $(NVBOARD_HOME)/scripts/auto_pin_bind.py $^ $@

# rules for verilator
INCLUDES += $(addprefix -I, $(INC_PATH))
CFLAGS +=  $(INCLUDES) -Wall -DTOP_NAME="\"V$(TOPNAME)\"" -g #-D__GUEST_ISA__=$(GUEST_ISA)
CXXFLAGS := $(filter-out -D__STDC_FORMAT_MACROS, $(CXXFLAGS))
LDFLAGS += -lreadline -ldl -lSDL2  -pie $(LIBS) #-fsanitize=address


override ARGS ?= --log=$(BUILD_DIR)/npc-log.txt  #--ftrace=$(BUILD_DIR)/$(ALL)-$(ARCH).elf
override ARGS += $(ARGS_DIFF) #--batch

$(BIN): $(SRCS) $(VSRCS) 
	$(VERILATOR) $(VERILATOR_CFLAGS) \
		--top-module $(TOPNAME) $^ $(addprefix -CFLAGS , $(CFLAGS)) \
		$(addprefix -LDFLAGS , $(LDFLAGS)) \
		$(addprefix -CFLAGS , $(CXXFLAGS))	\
		--Mdir $(OBJ_DIR) --exe -o $(abspath $(BIN))
	

$(shell mkdir -p $(BUILD_DIR))

IMG ?= char-test.bin

# riscv64-linux-gnu-gcc -fno-pic -march=rv32e_zicsr -mabi=ilp32e -mcmodel=medany -mstrict-align  -c char-test.c -o char-test.o
# ld 
# riscv64-linux-gnu-objcopy -S --set-section-flags .bss=alloc,contents -O binary char-test.o char-test.bin
# riscv64-linux-gnu-objdump -d char-test.o

run:$(BIN)
	$(call git_commit, "sim RTL") #DO NOT REMOVE THIS LINE!!!
	$(EXE)  $(ARGS) $(IMG)

gdb:$(BIN)
	$(call git_commit, "sim RTL") #DO NOT REMOVE THIS LINE!!!
	gdb -s $(EXE) --args $(EXE) $(ARGS) $(IMG)

.PHONY:wave clean sim default all run $(DIFF_REF_SO)

wave:
	gtkwave $(WAVE)

clean:
	$(RM) -r $(BUILD_DIR) $(WAVE) $(EXE)

include ../Makefile
